<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.surpass.persistence.mapper.VoucherItemMapper">
    <select id="selectSubjectAmount" parameterType="com.surpass.entity.statement.dto.StatementParamsDto"
            resultType="com.surpass.entity.voucher.vo.VoucherItemVo">
        SELECT
	        i.subject_code as subjectCode,
	        ${params.countType}(i.debit_amount) AS debitAmount,
	        ${params.countType}(i.credit_amount) AS creditAmount
        FROM jbx_voucher_item i
        JOIN jbx_voucher v
        ON i.book_id = v.book_id and i.voucher_id = v.id
        WHERE 	v.book_id = #{params.bookId}
	        AND i.deleted = 'n'
	        AND v.deleted = 'n'
	        AND v.status = 'completed'
	        <if test="params.year != null">
	            AND YEAR(i.voucher_date) = #{params.year}
	        </if>
	        <if test="params.month != null">
	            AND MONTH(i.voucher_date) = #{params.month}
	        </if>
	        <if test="params.quarter != null">
	            AND QUARTER(i.voucher_date) = #{params.quarter}
	        </if>
	        <if test="params.dateRangeStart != null">
	        	AND i.voucher_date >= str_to_date(#{params.dateRangeStart}, '%Y-%m-%d')
	        </if>
	        <if test="params.dateRangeEnd != null">
	        	AND str_to_date(#{params.dateRangeEnd}, '%Y-%m-%d') >= i.voucher_date
	        </if>

        GROUP BY i.subject_code
        ORDER BY i.subject_code asc
    </select>

    <select id="subLedgerPage" parameterType="com.surpass.entity.voucher.dto.VoucherItemPageDto"
            resultType="com.surpass.entity.voucher.vo.VoucherItemVo">
        SELECT i.*, v.word
        FROM jbx_voucher_item i
        LEFT JOIN jbx_voucher v ON i.voucher_id = v.id
        WHERE v.book_id = #{params.bookId}
        AND i.deleted = 'n'
        AND v.deleted = 'n'
        AND v.status = 'completed'
        <if test="params.year != null">
            AND YEAR(i.voucher_date) = #{params.year}
        </if>
        <if test="params.month != null">
            AND MONTH(i.voucher_date) = #{params.month}
        </if>
        <if test="params.quarter != null">
            AND QUARTER(i.voucher_date) = #{params.quarter}
        </if>
        <if test="params.subjectCode != null and params.subjectCode != ''">
            AND i.subject_code like CONCAT(#{params.subjectCode}, '%')
        </if>
        <if test="params.subjectId != null and params.subjectId != ''">
            AND i.subject_id = #{params.subjectId}
        </if>
        <if test="params.summary != null and params.summary != ''">
            AND i.summary like CONCAT(#{params.summary}, '%')
        </if>
        <if test="params.voucherId != null and params.voucherId != ''">
            AND i.voucher_id = #{params.voucherId}
        </if>
    </select>

    <!-- 公共查询条件片段 -->
    <sql id="dynamicQueryConditions">
        <if test="params.belongDateRange != null and params.belongDateRange.length == 2">
            and v.voucher_date between #{params.belongDateRange[0]} and #{params.belongDateRange[1]}
        </if>
    </sql>

    <select id="fetchByCashFlow"
            parameterType="com.surpass.entity.voucher.dto.VoucherItemPageDto"
            resultType="com.surpass.entity.voucher.vo.VoucherItemVo">
        SELECT
        v.word,
        COALESCE(aux.auxiliaryLabel, '') AS auxiliaryLabel,
        jvicf.*,
        i.id as voucherItemId,
        v.voucher_date as voucherDate,
        i.summary as summary,
        jbs.display_name as subjectName,
        i.debit_amount as debitAmount,
        i.credit_amount as creditAmount,
        v.id as voucherId
        FROM jbx_voucher_item_cash_flow jvicf
        RIGHT JOIN jbx_voucher_item i on jvicf.voucher_item_id = i.id
        and jvicf.book_id = #{params.bookId}
        and jvicf.cash_flow_item_type = #{params.cashFlowItemType}
        JOIN jbx_voucher v ON i.voucher_id = v.id
        LEFT JOIN (
        SELECT
        voucher_item_id,
        GROUP_CONCAT(
        CONCAT(auxiliary_name, ':', item_name)
        SEPARATOR '；'
        ) AS auxiliaryLabel
        FROM jbx_voucher_auxiliary
        WHERE voucher_item_id IN (
        SELECT i.id
        FROM jbx_voucher_item i
        JOIN jbx_voucher v ON i.voucher_id = v.id
        WHERE i.deleted = 'n'
        AND v.deleted = 'n'
        AND v.book_id = #{params.bookId}
        AND v.status = 'completed'
        <include refid="dynamicQueryConditions"/>
        )
        GROUP BY voucher_item_id
        ) aux ON i.id = aux.voucher_item_id
        join jbx_book_subject jbs on i.subject_id = jbs.id
        and jbs.book_id = #{params.bookId}
        and jbs.deleted = 'n'
        WHERE i.deleted = 'n'
        AND v.deleted = 'n'
        AND v.book_id = #{params.bookId}
        AND v.status = 'completed'

        /* 排除现金类科目本身 */
        AND NOT (
/*        jbs.display_name LIKE '%库存现金%'
        OR jbs.display_name LIKE '%银行存款%'
        OR jbs.display_name LIKE '%其他货币资金%'
        OR jbs.display_name LIKE '%货币资金%'
        OR jbs.code LIKE '1001%'
        OR jbs.code LIKE '1002%'
        OR jbs.code LIKE '1003%'
        OR jbs.display_name LIKE '%现金%'*/
            jbs.is_cash = 1
        )
        <if test="params.cashFlowItemType == 0">
            /* 主表项目：需要检查凭证是否包含现金类科目 */
            AND EXISTS (
            SELECT 1 FROM jbx_voucher_item cash_items
            join jbx_book_subject jbs on cash_items.subject_id = jbs.id
            and jbs.book_id = #{params.bookId}
            and jbs.deleted = 'n'
            WHERE cash_items.voucher_id = v.id
            AND cash_items.deleted = 'n'
            AND (
          /*  jbs.display_name LIKE '%库存现金%'
            OR jbs.display_name LIKE '%银行存款%'
            OR jbs.display_name LIKE '%其他货币资金%'
            OR jbs.display_name LIKE '%货币资金%'
            OR jbs.code LIKE '1001%'
            OR jbs.code LIKE '1002%'
            OR jbs.code LIKE '1003%'
            OR jbs.display_name LIKE '%现金%'*/
                jbs.is_cash = 1
            )
            )
            /* 移除对累计折旧等科目的限制，因为只要凭证中有现金类科目，这些科目也可以设置主表项目 */
        </if>
        <if test="params.cashFlowItemType == 1">
            /* 补充资料项目：无需特殊限制，所有非现金类科目都可以设置补充资料 */
        </if>
        <if test="params.cashFlowItemCode != null and params.cashFlowItemCode != ''">
            and jvicf.cash_flow_item_code = #{params.cashFlowItemCode}
        </if>
        <include refid="dynamicQueryConditions"/>
        order by v.id ASC
    </select>

    <select id="voucherSubjectBalanceSummary" parameterType="com.surpass.entity.statement.dto.StatementParamsDto"
            resultType="com.surpass.entity.statement.StatementSubjectBalance">
     select
     	jvtsum.subject_code ,
     	jbs.name as subject_name ,
     	sum(jvtsum.debit_amount) current_period_debit,
     	sum(jvtsum.credit_amount) current_period_credit
     from (
     	SELECT
     		substr(jvi.subject_code,1,4) subject_code,
     		jvi.debit_amount,
     		jvi.credit_amount
     	FROM jbx_voucher_item jvi,jbx_voucher  jv
		 where
			jvi.book_id = #{bookId}
		    and jv.book_id=#{bookId}
			and jvi.deleted='n'
		    and jvi.voucher_id = jv.id
		    and jvi.book_id=jv.book_id
		    and jv.deleted='n'
		    and jv.status='completed'
		    <if test="year != null">
	            AND YEAR(jv.voucher_date) = #{year}
	        </if>
	        <if test="month != null">
	            AND MONTH(jv.voucher_date) = #{month}
	        </if>
	        <if test="quarter != null">
	            AND QUARTER(jv.voucher_date) = #{quarter}
	        </if>
	        <if test="dateRangeStart != null">
	        	AND jv.voucher_date >= str_to_date(#{dateRangeStart}, '%Y-%m-%d')
	        </if>
	        <if test="dateRangeEnd != null">
	        	AND str_to_date(#{dateRangeEnd}, '%Y-%m-%d') >= jv.voucher_date
	        </if>
		) jvtsum
		left join jbx_book_subject jbs
		on jvtsum.subject_code = jbs.code and jbs.book_id=#{bookId}
		group by subject_code,subject_name
		order by subject_code  asc
    </select>
</mapper>
