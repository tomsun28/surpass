<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.surpass.persistence.mapper.SessionListMapper" >

	<sql id="dao_where_statement">
    	<if test="id != null and id != ''">
			and	id	=	#{id}
		</if>
		<if test="userId != null and userId != ''">
			and	userId	=	#{userId}
		</if>
		<if test="username != null and username != '' ">
			and lower(username) like lower(concat('%',#{username},'%'))
		</if>
		<if test="message != null and message != '' ">
			and lower(message) like lower(concat('%',#{message},'%'))
		</if>
		<if test="displayName != null and displayName != '' ">
			and lower(displayname) like lower(concat('%',#{displayName},'%'))
		</if>

		<if test="startDate != null and startDate != ''">
			and	operatetime	>=	#{startDate}
		</if>
		<if test="endDate != null and endDate != ''">
			and	 #{endDate}	>=	operatetime
		</if>
		<if test="sessionId != null and sessionId != ''">
			and	sessionid	=	#{sessionId}
		</if>
		<if test="loginType != null and loginType != ''">
			and	logintype	=	#{loginType}
		</if>
		<if test="ipAddr != null and ipAddr != ''">
			and	ipaddr	=	#{ipAddr}
		</if>
		<if test="style != null and style != ''">
			and	style	=	#{style}
		</if>
		<if test="gradingUserId != null and gradingUserId != ''">
			and userId in(
				select rg.grading
				from jbx_group_gradings rg,jbx_groups r,jbx_group_member rm, surpass_userinfo u
				where r.id=rm.groupid and rm.memberid =u.id
				and rg.groupid=r.id and rg.type='org' and u.id=#{gradingUserId}
				and r.deleted = 'n' and u.deleted = 'n'
			)
		</if>
    </sql>



     <select id="fetchPageResults" parameterType="SessionList" resultType="SessionList">
    	select
			id,
	   		sessionid,
			userId,
			username,
			displayname,
			logintype,
			message,
			code,
			provider,
			ipaddr,
			country,
			province,
			city,
			location,
			browser,
			platform,
			application,
			operatetime,
			style
    	from jbx_session_list
    	<where>
			<include refid="dao_where_statement"/>
		</where>
    	order by operatetime desc
    </select>

</mapper>
