<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.surpass.persistence.mapper.VoucherItemCashFlowMapper">
    <!-- 公共查询条件片段 -->
    <sql id="dynamicQueryConditions">
        <if test="params.voucherId != null and params.voucherId != ''">
            AND v.deleted = 'n'
            AND v.book_id = #{params.bookId}
            AND v.status = 'completed'
            and v.id = #{params.voucherId}
        </if>
    </sql>

    <select id="getCashFlowItems"
            parameterType="com.surpass.entity.voucher.dto.VoucherItemPageDto"
            resultType="com.surpass.entity.voucher.vo.VoucherItemVo">
        SELECT
        v.word,
        COALESCE(aux.auxiliaryLabel, '') AS auxiliaryLabel,
        jvicf.*,
        COALESCE(jvicf.cash_flow_item_code, 'no-select') AS cashFlowItemCode,
        i.id as voucherItemId,
        v.voucher_date as voucherDate,
        i.summary as summary,
        jbs.display_name as subjectName,
        i.debit_amount as debitAmount,
        i.credit_amount as creditAmount,
        v.id as voucherId
        FROM jbx_voucher_item_cash_flow jvicf
        RIGHT JOIN jbx_voucher_item i on jvicf.voucher_item_id = i.id
        and jvicf.book_id = #{params.bookId}
        and jvicf.cash_flow_item_type = #{params.cashFlowItemType}
        JOIN jbx_voucher v ON i.voucher_id = v.id
        LEFT JOIN (
        SELECT
        voucher_item_id,
        GROUP_CONCAT(
        CONCAT(auxiliary_name, ':', item_name)
        SEPARATOR '；'
        ) AS auxiliaryLabel
        FROM jbx_voucher_auxiliary
        WHERE voucher_item_id IN (
        SELECT i.id
        FROM jbx_voucher_item i
        JOIN jbx_voucher v ON i.voucher_id = v.id
        WHERE i.deleted = 'n'
        <include refid="dynamicQueryConditions"/>
        )
        GROUP BY voucher_item_id
        ) aux ON i.id = aux.voucher_item_id
        join jbx_book_subject jbs on i.subject_id = jbs.id
        and jbs.book_id = #{params.bookId}
        and jbs.deleted = 'n'
        WHERE i.deleted = 'n'

        /* 排除现金类科目本身 */
        AND NOT (
       /* jbs.display_name LIKE '%库存现金%'
        OR jbs.display_name LIKE '%银行存款%'
        OR jbs.display_name LIKE '%其他货币资金%'
        OR jbs.display_name LIKE '%货币资金%'
        OR jbs.code LIKE '1001%'
        OR jbs.code LIKE '1002%'
        OR jbs.code LIKE '1003%'
        OR jbs.display_name LIKE '%现金%'*/
            jbs.is_cash = 1
        )
        <if test="params.cashFlowItemType == 0">
            /* 主表项目：需要检查凭证是否包含现金类科目 */
            AND EXISTS (
            SELECT 1 FROM jbx_voucher_item cash_items
            join jbx_book_subject jbs on cash_items.subject_id = jbs.id
            and jbs.book_id = #{params.bookId}
            and jbs.deleted = 'n'
            WHERE cash_items.voucher_id = v.id
            AND cash_items.deleted = 'n'
            AND (
     /*       jbs.display_name LIKE '%库存现金%'
            OR jbs.display_name LIKE '%银行存款%'
            OR jbs.display_name LIKE '%其他货币资金%'
            OR jbs.display_name LIKE '%货币资金%'
            OR jbs.code LIKE '1001%'
            OR jbs.code LIKE '1002%'
            OR jbs.code LIKE '1003%'
            OR jbs.display_name LIKE '%现金%'*/
            jbs.is_cash = 1
            )
            )
            /* 移除对累计折旧等科目的限制，因为只要凭证中有现金类科目，这些科目也可以设置主表项目 */
        </if>
        <if test="params.cashFlowItemType == 1">
            /* 补充资料项目：无需特殊限制，所有非现金类科目都可以设置补充资料 */
        </if>

        <if test="params.cashFlowItemCode != null and params.cashFlowItemCode != ''">
            and jvicf.cash_flow_item_code = #{params.cashFlowItemCode}
        </if>
        <include refid="dynamicQueryConditions"/>
        order by i.id
    </select>

    <select id="getIdsWhenDelete"
            parameterType="map"
            resultType="string">
        select jvicf.id
            from jbx_voucher_item_cash_flow jvicf
        join jbx_voucher_item jvi
        on jvi.id = jvicf.voucher_item_id
        and jvi.voucher_id = #{params.voucherId}
        and jvi.deleted = 'n'
        where jvicf.book_id = #{params.bookId}
        and jvicf.cash_flow_item_type = #{params.cashFlowItemType}
    </select>
</mapper>
